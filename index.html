<script>
        // ==========================================
        //  診斷模式程式碼 - 會自動抓出錯誤並彈窗提示
        // ==========================================

        // --- 1. 請在此處填入您的設定 (請小心不要刪掉引號或逗號) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_uFmhh4ENTSHo1oGCW8vEUymDy56c4PE",
            authDomain: "jamielove-map.firebaseapp.com",
            // 注意：請確認下方網址是 firebaseio.com 還是 firebasedatabase.app
            databaseURL: "https://jamielove-map-default-rtdb.firebaseio.com",
            projectId: "jamielove-map",
            storageBucket: "jamielove-map.firebasestorage.app",
            messagingSenderId: "971633917617",
            appId: "1:971633917617:web:95c1b6c57ebc3a530bac90",
        };

        // --- 錯誤捕捉系統 ---
        window.onerror = function(msg, url, line) {
            alert("程式發生嚴重錯誤，請截圖給工程師：\n" + msg + "\n行數：" + line);
            return false;
        };

        try {
            // 初始化 Firebase
            if (typeof firebase === 'undefined') {
                throw new Error("無法載入 Firebase 核心，請檢查網路連線");
            }
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            var db = firebase.database();
            var auth = firebase.auth();
            var provider = new firebase.auth.GoogleAuthProvider();
            
            console.log("Firebase 初始化成功");

        } catch (e) {
            alert("Firebase 設定錯誤！\n請檢查您填入的 API Key 格式是否正確（有沒有少逗號？）\n錯誤訊息：" + e.message);
        }

        // --- 全域變數 ---
        var map;
        let myUid = null;
        let isAdmin = false;
        let userNickname = "訪客";
        let markers = {};
        const playSnd = (id) => { try { document.getElementById(id).play(); } catch(e){} };

        // --- 啟動程式 ---
        window.onload = function() {
            try {
                // 1. 嘗試載入地圖
                map = L.map('map', { zoomControl: false }).setView([24.1477, 120.6736], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                console.log("地圖載入成功");

                // 2. 監聽登入狀態
                auth.onAuthStateChanged((user) => {
                    const loginBtn = document.getElementById('loginBtn');
                    const msgWall = document.getElementById('msgWall');
                    
                    if (user) {
                        console.log("使用者已登入:", user.uid);
                        myUid = user.uid;
                        userNickname = user.displayName;
                        loginBtn.innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> 登出';

                        // 讀取管理員權限
                        db.ref('admins/' + myUid).once('value').then(snapshot => {
                            if (snapshot.exists() && snapshot.val() === true) {
                                isAdmin = true;
                                msgWall.style.display = 'block';
                                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                                loginBtn.innerHTML = '<i class="fa-solid fa-user-shield"></i> 管理員';
                                alert("歡迎管理員！權限驗證成功。");
                            } else {
                                isAdmin = false;
                                msgWall.style.display = 'none';
                                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                            }
                            initListeners();
                            playSnd('sndDoorbell');
                        }).catch(err => {
                            alert("資料庫讀取失敗！\n1. 請檢查「安全性規則」是否已發布\n2. 請檢查 databaseURL 是否正確\n錯誤：" + err.message);
                        });

                    } else {
                        console.log("未登入狀態");
                        myUid = null;
                        isAdmin = false;
                        loginBtn.innerHTML = '<i class="fa-brands fa-google"></i> 登入';
                        msgWall.style.display = 'none';
                    }
                });

            } catch (e) {
                alert("初始化過程失敗：" + e.message);
            }
        };

        // --- 功能函數 ---
        function handleGoogleLogin() {
            if (!myUid) {
                auth.signInWithPopup(provider).catch(error => {
                    alert("登入失敗！\n代碼：" + error.code + "\n原因：" + error.message + "\n\n(如果是 auth/unauthorized-domain，請去 Firebase 設定授權網域)");
                });
            } else {
                auth.signOut().then(() => location.reload());
            }
        }

        function initListeners() {
            if(!myUid) return;
            // 監聽位置
            db.ref('users').on('value', snapshot => {
                const users = snapshot.val() || {};
                Object.keys(users).forEach(uid => {
                    if (users[uid].lat && users[uid].lng) updateMarker(uid, users[uid]);
                });
            });
            // 監聽聊天
            db.ref('chat').limitToLast(1).on('child_added', snapshot => {
                const msg = snapshot.val();
                if (Date.now() - msg.timestamp < 10000) playSnd('sndMSN');
            });
        }

        function updateMarker(uid, data) {
            let icon = L.divIcon({
                className: 'custom-avatar',
                html: `<div class="status-label">${data.status || '...'}</div>
                       <div class="user-avatar-icon" style="background:${data.color || '#007bff'}">${data.nickname ? data.nickname[0] : '?'}</div>`
            });
            if (markers[uid]) markers[uid].setLatLng([data.lat, data.lng]).setIcon(icon);
            else markers[uid] = L.marker([data.lat, data.lng], {icon: icon}).addTo(map);
        }

        function locateUser() {
            if(!myUid) return alert("請先登入");
            map.locate({setView: true, maxZoom: 16});
        }

        map.on('locationfound', e => {
            if(myUid) db.ref('users/' + myUid).update({ lat: e.latlng.lat, lng: e.latlng.lng });
        });

        function setStatus(btn, status, color) {
            if(!myUid) return alert("請先登入");
            playSnd('sndBike');
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            db.ref('users/' + myUid).update({ status: status, color: color });
        }

        function toggleChat() {
            const win = document.getElementById('chatWindow');
            win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
            if(win.style.display === 'flex') { loadChat(); playSnd('sndMSN'); }
        }

        function loadChat() {
            const body = document.getElementById('chatBody');
            body.innerHTML = '';
            db.ref('chat').limitToLast(20).once('value', snap => {
                snap.forEach(child => {
                    let msg = child.val();
                    body.innerHTML += `<div style="margin-bottom:5px;"><strong>${msg.sender}:</strong> ${msg.text}</div>`;
                });
                body.scrollTop = body.scrollHeight;
            });
        }

        function sendMsg() {
            const input = document.getElementById('msgInput');
            if(input.value && myUid) {
                db.ref('chat').push({ text: input.value, sender: userNickname, timestamp: firebase.database.ServerValue.TIMESTAMP });
                input.value = '';
                playSnd('sndMSN');
                loadChat();
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('dropdownList');
            menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        }
        
        function changeNickname() {
            let name = prompt("新暱稱:", userNickname);
            if(name && myUid) db.ref('users/' + myUid).update({nickname: name});
        }
        function editAnnouncement() { if(isAdmin) { let t = prompt("新公告:"); if(t) db.ref('announcements/text').set(t); } }

        window.addEventListener('resize', function(){ map.invalidateSize(); });
    </script>
