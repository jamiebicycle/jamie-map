<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ·ç±³æ¨‚å–®è»Šè³½äº‹èª¿åº¦æ¿ (v5.4)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { overflow: hidden; background-color: #eee; width: 100vw; height: 100dvh; display: flex; flex-direction: column; user-select: none; -webkit-user-select: none; }

        /* --- ä¸Šæ–¹å·¥å…·åˆ— --- */
        .top-bar {
            flex: 0 0 auto; background: rgba(255,255,255,0.95); 
            padding-top: max(8px, env(safe-area-inset-top)); padding-bottom: 8px;
            padding-left: 10px; padding-right: 10px;
            display: flex; justify-content: space-between; gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2000;
        }

        #map-container { flex: 1; position: relative; width: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 0; }

        .bottom-area {
            flex: 0 0 auto; display: flex; flex-direction: column; gap: 5px; 
            padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom));
            background: #222; z-index: 2000; color: white;
        }

        /* --- UI å…ƒä»¶ --- */
        .top-btn {
            flex: 1; border: none; border-radius: 8px; font-weight: bold;
            font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            text-decoration: none; color: #333; border: 1px solid #ccc;
            background: white; height: 44px;
        }
        .top-btn:active { background: #f0f0f0; transform: scale(0.98); }
        
        /* Zello æŒ‰éˆ•æ¨£å¼ */
        .btn-zello { background-color: #ff9800; color: white; border-color: #e65100; }
        .btn-login { background-color: #d32f2f; color: white; border-color: #b71c1c; }

        .gps-float-btn {
            position: absolute; top: 15px; right: 15px; width: 50px; height: 50px;
            background-color: white; border: 2px solid #ccc; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 1000;
            font-size: 24px; color: #333;
        }

        #lockScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        #lockScreen h2 { margin-bottom: 20px; color: #ff9800; }

        /* é¸å–®æ¨£å¼ */
        .dropdown-menu {
            position: fixed; top: 80px; left: 10px; background: #3b78c4;
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; flex-direction: column; width: 260px;
            overflow: hidden; max-height: 60vh; overflow-y: auto; z-index: 3000;
            border: 2px solid white;
        }
        .menu-header { background: #1e4a7a; color: white; padding: 12px; font-weight: bold; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.3); }
        .menu-item { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 10px; color: white; font-weight: bold; }
        .menu-item:active { background: rgba(0,0,0,0.2); }
        .admin-only { display: none; } 

        /* èŠå¤©å®¤ */
        .chat-window {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; height: 60vh;
            background: rgba(30, 30, 30, 0.98); border-radius: 12px; color: white;
            display: none; flex-direction: column; z-index: 4000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); border: 1px solid #555;
        }
        .chat-header { background: #1976d2; padding: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-radius: 12px 12px 0 0;}
        .chat-body { flex: 1; padding: 10px; overflow-y: auto; font-size: 15px; }
        .chat-input-area { display: flex; padding: 10px; background: #222; border-radius: 0 0 12px 12px; }
        .chat-input-area input { flex: 1; padding: 10px; border-radius: 6px; border: none; font-size: 16px; }
        .chat-input-area button { margin-left: 8px; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; }
        .chat-link { color: #4fc3f7; text-decoration: underline; word-break: break-all; }

        /* åº•éƒ¨æŒ‰éˆ• */
        .status-bar { display: flex; gap: 8px; height: 55px; }
        .status-btn {
            flex: 1; border: none; color: white; font-weight: bold; font-size: 16px;
            border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.4); opacity: 0.6;
        }
        .status-btn.active { opacity: 1; transform: scale(1.02); border: 2px solid white; box-shadow: 0 0 10px white; }
        .st-going { background-color: #d32f2f; }
        .st-arrived { background-color: #fbc02d; color: black; }
        .st-fixing { background-color: #388e3c; }
        .st-done { background-color: #1976d2; }

        /* å…¬å‘Šèˆ‡ç›£æ§ç‰† */
        .public-announcement {
            background: rgba(0, 0, 0, 0.85); color: #ffeb3b; padding: 10px; border-radius: 6px; font-size: 15px;
            text-align: center; display: block; border: 2px solid #fbc02d; margin-bottom: 5px;
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.2); font-weight: bold;
            cursor: pointer;
        }
        .admin-private-wall {
            background: rgba(13, 71, 161, 0.9); color: #fff; padding: 5px; border-radius: 5px; font-size: 12px;
            display: none; border-left: 4px solid #00e5ff; margin-bottom: 5px; max-height: 60px; overflow-y: auto;
        }

        /* é ­åƒæ¨£å¼ */
        .custom-avatar { text-align: center; }
        .user-avatar-icon {
            background-color: #2196f3; color: white; border: 2px solid white;
            border-radius: 50%; text-align: center; line-height: 36px;
            font-weight: bold; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            width: 36px !important; height: 36px !important; margin: 0 auto;
        }
        .status-label {
            background: white; border: 1px solid #ccc; border-radius: 4px; 
            padding: 2px 5px; font-size: 12px; white-space: nowrap; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); font-weight: bold;
            position: absolute; top: -22px; left: 50%; transform: translateX(-50%);
            z-index: 100;
        }

        #gpxInput { display: none; }
    </style>
</head>
<body>

    <div id="lockScreen" style="display: none;">
        <i class="fa-solid fa-lock fa-3x" style="margin-bottom: 20px;"></i>
        <h2>ç­‰å¾…å¯©æ ¸ä¸­</h2>
        <p>æ‚¨çš„ Google å¸³è™Ÿå·²é€£ç·šã€‚</p>
        <p>è«‹ç­‰å¾…ç®¡ç†å“¡æ‰¹å‡†æ‚¨çš„åŠ å…¥æ¬Šé™ã€‚</p>
        <p id="myUidDisplay" style="font-size: 12px; color: #aaa; margin-top: 10px;"></p>
        <button onclick="handleLogout()" style="margin-top: 20px; padding: 10px 20px; border:none; border-radius:5px; background:#d32f2f; color:white;">å–æ¶ˆä¸¦ç™»å‡º</button>
    </div>

    <div class="top-bar pointer-auto">
        <button id="menuBtn" class="top-btn btn-menu" onclick="toggleMenu()">
            <i class="fa-solid fa-gear"></i> é¸å–®
        </button>
        <a href="zello://?freq&name=JamieBikeTeam" class="top-btn btn-zello" style="text-decoration:none;">
            <i class="fa-solid fa-walkie-talkie"></i> ç„¡ç·šé›»
        </a>
        <button class="top-btn btn-chat" onclick="toggleChat()">
            <i class="fa-solid fa-comments"></i> èŠå¤©
        </button>
        <button id="loginBtn" class="top-btn btn-login" onclick="handleGoogleLogin()">
            <i class="fa-brands fa-google"></i> ç™»å…¥
        </button>
    </div>

    <div id="map-container">
        <div id="map"></div>
        <button class="gps-float-btn pointer-auto" onclick="locateUser()">
            <i class="fa-solid fa-crosshairs"></i>
        </button>
    </div>

    <div class="bottom-area pointer-auto">
        <div id="adminPrivateWall" class="admin-private-wall"></div>
        <div id="publicAnnouncement" class="public-announcement" onclick="editAnnouncement()">ğŸ“¢ å…¬å‘Šï¼šè«‹ç™»å…¥ä»¥é–‹å§‹ä½¿ç”¨</div>
        <div class="status-bar">
            <button class="status-btn st-going" onclick="setStatus(this, 'å‰å¾€ä¸­', '#d32f2f')">å‰å¾€ä¸­</button>
            <button class="status-btn st-arrived" onclick="setStatus(this, 'å·²æŠµé”', '#fbc02d')">å·²æŠµé”</button>
            <button class="status-btn st-fixing" onclick="setStatus(this, 'ç¶­ä¿®ä¸­', '#388e3c')">ç¶­ä¿®ä¸­</button>
            <button class="status-btn st-done" onclick="setStatus(this, 'å·²å®Œæˆ', '#1976d2')">å·²å®Œæˆ</button>
        </div>
    </div>

    <div id="dropdownList" class="dropdown-menu pointer-auto">
        <div class="menu-header">ç®¡ç†å“¡ä¸‹æ‹‰é¸å–®</div>
        
        <div class="menu-item admin-only" onclick="alert('åŠŸèƒ½: ç·¨è¼¯ç®¡ç†å“¡')">1. ç·¨è¼¯ç®¡ç†å“¡(æ–°å¢/åˆªé™¤)</div>
        <div class="menu-item admin-only" onclick="reviewMembers()">2. ç·¨è¼¯æˆå“¡(æ–°å¢/ä¿®æ”¹/åˆªé™¤)</div>
        
        <div class="menu-item admin-only">
            <label for="gpxInput" style="padding:0; border:none; width:100%; display:block;">3. åœ°åœ–ç®¡ç†(GPXåŒ¯å…¥/åˆªé™¤)</label>
        </div>
        <input type="file" id="gpxInput" accept=".gpx" onchange="loadGPX(this)">
        <div class="menu-item admin-only text-danger" onclick="removeGPX()" style="color:red; font-size:14px; padding-left:30px;">â”” æ¸…é™¤ GPX</div>

        <div class="menu-item admin-only" onclick="exportChatXLS()">4. èŠå¤©å®¤ç®¡ç†(åŒ¯å‡º/åˆªé™¤)</div>
        <div class="menu-item admin-only" onclick="exportWallLogXLS()">5. è¨Šæ¯ç‰†ç®¡ç†(åŒ¯å‡º/åˆªé™¤)</div>

        <div class="menu-header" style="font-size:14px; padding:8px;">å€‹äººè¨­å®š</div>
        
        <div class="menu-item admin-only" onclick="editAnnouncement()">6. ç™¼å¸ƒå…¬å‘Š</div>
        <div class="menu-item" onclick="changeNickname()">7. ä¿®æ”¹æš±ç¨±</div>
        
        <div style="text-align:center; background:#1e4a7a; color:white; padding:12px;" onclick="toggleMenu()">â–² é—œé–‰é¸å–®</div>
    </div>

    <div id="chatWindow" class="chat-window pointer-auto">
        <div class="chat-header">
            <span>åœ˜éšŠèŠå¤©å®¤</span>
            <span style="cursor:pointer; font-size:20px;" onclick="toggleChat()">Ã—</span>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-input-area">
            <button class="btn-img" onclick="insertImage()"><i class="fa-regular fa-image"></i></button>
            <input type="text" id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯...">
            <button class="btn-send" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <audio id="sndDoorbell" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sndMSN" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3"></audio>
    <audio id="sndBike" src="https://assets.mixkit.co/active_storage/sfx/1857/1857-preview.mp3"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <script>
        // ==========================================
        //  è«‹å‹™å¿…åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Key
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyB_uFmhh4ENTSHo1oGCW8vEUymDy56c4PE",
            authDomain: "jamielove-map.firebaseapp.com",
            databaseURL: "https://jamielove-map-default-rtdb.firebaseio.com",
            projectId: "jamielove-map",
            storageBucket: "jamielove-map.firebasestorage.app",
            messagingSenderId: "971633917617",
            appId: "1:971633917617:web:95c1b6c57ebc3a530bac90",
        };

        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        var db = firebase.database();
        var auth = firebase.auth();
        var provider = new firebase.auth.GoogleAuthProvider();

        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

        // --- å…¨åŸŸè®Šæ•¸ ---
        var map = L.map('map', { zoomControl: true }).setView([24.1477, 120.6736], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

        let isAdmin = false;
        let isChatOpen = false;
        let currentGpxLayer = null;
        let myUid = null;
        let userNickname = "è¨ªå®¢";
        let markers = {}; 
        let polylines = {};
        let isListening = false;

        // --- éŸ³æ•ˆæ’­æ”¾ ---
        function playSnd(id) {
            try {
                let audio = document.getElementById(id);
                if(audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio block", e));
                }
            } catch(e) {}
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    myUid = user.uid;
                    userNickname = user.displayName || "éšŠå“¡";
                    document.getElementById('loginBtn').innerHTML = `<i class="fa-solid fa-right-from-bracket"></i> ç™»å‡º`;
                    
                    playSnd('sndDoorbell'); // ç™»å…¥éŸ³æ•ˆ

                    db.ref('users/' + myUid).once('value').then(snapshot => {
                        let userData = snapshot.val();
                        if (!userData) {
                            db.ref('users/' + myUid).set({
                                nickname: userNickname,
                                status: 'è¨»å†Šä¸­',
                                role: 'pending', 
                                lastSeen: firebase.database.ServerValue.TIMESTAMP
                            });
                            showLockScreen(true);
                        } else if (userData.role === 'pending') {
                            showLockScreen(true);
                        } else if (userData.role === 'banned') {
                            alert("æ‚¨å·²è¢«å°é–");
                            auth.signOut();
                        } else {
                            showLockScreen(false);
                            enterMainSystem();
                        }
                    });

                    db.ref('users/' + myUid + '/role').on('value', snap => {
                        let r = snap.val();
                        if (r === 'active' || r === 'admin') {
                            showLockScreen(false);
                            if(r === 'admin') { isAdmin = true; updateAdminUI(); }
                        } else if (r === 'banned') {
                            alert("æ‚¨å·²è¢«å°é–"); auth.signOut(); location.reload();
                        }
                    });
                } else {
                    myUid = null;
                    isAdmin = false;
                    document.getElementById('loginBtn').innerHTML = `<i class="fa-brands fa-google"></i> ç™»å…¥`;
                    showLockScreen(false);
                    updateAdminUI();
                    document.getElementById('publicAnnouncement').innerText = "ğŸ“¢ è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ";
                }
            });
            
            document.getElementById('msgInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') sendMsg();
            });
        };

        function showLockScreen(show) {
            const lock = document.getElementById('lockScreen');
            if (show) {
                lock.style.display = 'flex';
                document.getElementById('myUidDisplay').innerText = "ID: " + myUid.slice(-6);
            } else {
                lock.style.display = 'none';
                if(myUid) initListeners();
            }
        }

        function enterMainSystem() {
            db.ref('users/' + myUid).update({
                nickname: userNickname,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            askAdminPassword();
        }

        function handleGoogleLogin() {
            if (myUid) handleLogout();
            else {
                auth.signInWithPopup(provider).catch(error => {
                    alert("ç™»å…¥å¤±æ•—: " + error.message);
                });
            }
        }

        function handleLogout() {
            auth.signOut().then(() => { alert("å·²ç™»å‡º"); location.reload(); });
        }

        // æ ¸å¿ƒæ¬Šé™é‚è¼¯ (å¼·åˆ¶å¯†ç¢¼è©¢å•)
        function askAdminPassword() {
            db.ref('users/' + myUid + '/role').once('value', snap => {
                if(snap.val() === 'admin') {
                    isAdmin = true; 
                    db.ref('admins/' + myUid).set(true); 
                    updateAdminUI();
                    return;
                }
                
                setTimeout(() => {
                    let input = prompt(`æ­¡è¿ ${userNickname}ï¼\nè‹¥æ‚¨æ˜¯ç®¡ç†å“¡ï¼Œè«‹è¼¸å…¥å¯†ç¢¼ï¼š\n(ä¸€èˆ¬æˆå“¡è«‹æŒ‰å–æ¶ˆ)`);
                    if (input === "Fire_Fire_54889427") { 
                        isAdmin = true;
                        db.ref('users/' + myUid).update({ role: 'admin' }); 
                        db.ref('admins/' + myUid).set(true);
                        alert("ç®¡ç†å“¡æ¬Šé™å·²å•Ÿå‹• ğŸ›¡ï¸");
                    }
                    updateAdminUI();
                }, 500);
            });
        }

        function updateAdminUI() {
            const adminItems = document.querySelectorAll('.admin-only');
            const adminWall = document.getElementById('adminPrivateWall');
            
            adminItems.forEach(el => el.style.display = isAdmin ? 'flex' : 'none');
            
            if (isAdmin) {
                adminWall.style.display = 'block';
                document.getElementById('menuBtn').innerHTML = `<i class="fa-solid fa-wrench"></i> ç®¡ç†`;
            } else {
                adminWall.style.display = 'none';
                document.getElementById('menuBtn').innerHTML = `<i class="fa-solid fa-gear"></i> é¸å–®`;
            }
        }

        function initListeners() {
            if (isListening) return;
            isListening = true;

            db.ref('users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                Object.keys(users).forEach(uid => {
                    if (uid === myUid) return; 
                    let u = users[uid];
                    if (u.role === 'active' || u.role === 'admin') {
                        updateMarker(uid, u);
                    }
                });
            });

            db.ref('chat').limitToLast(50).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                renderMessage(msg);
                if (Date.now() - msg.timestamp < 10000) playSnd('sndMSN'); // èŠå¤©éŸ³æ•ˆ
            });

            db.ref('announcement').on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    document.getElementById('publicAnnouncement').innerText = "ğŸ“¢ " + val.text;
                    playSnd('sndDoorbell'); // å…¬å‘ŠéŸ³æ•ˆ
                }
            });
        }

        function updateMarker(uid, u) {
            if (!u.lat || !u.lng) return;
            let statusText = u.status || '...';
            let icon = createAvatarIcon(u.color || "#2196f3", u.nickname, statusText);
            let popupContent = `<div style="text-align:center"><b>${u.nickname}</b><br>ç‹€æ…‹: ${statusText}</div>`;
            let latlng = [u.lat, u.lng];
            
            if (markers[uid]) {
                let oldPos = markers[uid].getLatLng();
                if (oldPos.distanceTo(latlng) > 5) {
                    if (!polylines[uid]) polylines[uid] = L.polyline([], {color: 'blue', weight: 3, opacity: 0.6}).addTo(map);
                    polylines[uid].addLatLng(latlng);
                }
                markers[uid].setLatLng(latlng).setIcon(icon);
                markers[uid].getPopup().setContent(popupContent);
            } else {
                let m = L.marker(latlng, { icon: icon }).addTo(map);
                m.bindPopup(popupContent);
                markers[uid] = m;
            }

            if (!polylines[uid]) {
                polylines[uid] = L.polyline([], {color: 'blue', weight: 3, opacity: 0.6}).addTo(map);
            }
            polylines[uid].addLatLng(latlng);
        }

        function createAvatarIcon(bgColor, name, status) {
            let initial = name ? name.charAt(0) : "?";
            let statusHtml = status ? `<div class="status-label" style="color:${bgColor}">${status}</div>` : '';
            return L.divIcon({
                className: 'custom-avatar',
                html: `${statusHtml}<div class="user-avatar-icon" style="background-color:${bgColor}; border-color:white;">${initial}</div>`,
                iconSize: [36, 36], iconAnchor: [18, 18], popupAnchor: [0, -20]
            });
        }

        function locateUser() {
            if(!myUid) { alert("è«‹å…ˆç™»å…¥"); return; }
            map.locate({setView: true, maxZoom: 16});
        }

        map.on('locationfound', function(e) {
            if(!myUid) return;
            db.ref('users/' + myUid).update({
                lat: e.latlng.lat, lng: e.latlng.lng,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            if (!markers['me']) {
                let icon = createAvatarIcon("#2196f3", userNickname, "æˆ‘");
                markers['me'] = L.marker(e.latlng, {icon:icon}).addTo(map).bindPopup("æˆ‘").openPopup();
            } else {
                markers['me'].setLatLng(e.latlng);
            }
        });

        function reviewMembers() {
            db.ref('users').orderByChild('role').equalTo('pending').once('value', snap => {
                let pendings = snap.val();
                if (!pendings) { alert("ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„æˆå“¡ã€‚"); toggleMenu(); return; }
                let list = "";
                Object.keys(pendings).forEach(key => {
                    list += `ç”³è«‹äºº: ${pendings[key].nickname}\n`;
                });
                
                let target = prompt(`å¾…å¯©æ ¸åå–®ï¼š\n${list}\nè«‹è¼¸å…¥è¦æ ¸å‡†çš„æš±ç¨±ï¼š`);
                if(target) {
                    let uidToApprove = Object.keys(pendings).find(key => pendings[key].nickname === target);
                    if(uidToApprove) {
                        db.ref('users/' + uidToApprove).update({ role: 'active' });
                        alert(`${target} å·²æ ¸å‡†é€²å…¥ï¼`);
                    } else { alert("æ‰¾ä¸åˆ°è©²æš±ç¨±"); }
                }
            });
            toggleMenu();
        }

        function setStatus(btn, statusText, colorCode) {
            if(!myUid) { alert("è«‹å…ˆç™»å…¥"); return; }
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            db.ref('users/' + myUid).update({ status: statusText, color: colorCode });
            
            playSnd('sndBike'); // ç‹€æ…‹éŸ³æ•ˆ = éˆ´éº
            
            if(isAdmin) logToAdmin(`${userNickname}: ${statusText}`);
        }

        function logToAdmin(text) {
            const wall = document.getElementById('adminPrivateWall');
            let time = new Date().toLocaleTimeString();
            wall.innerHTML = `<div>[${time}] ${text}</div>` + wall.innerHTML;
        }

        function sendMsg() {
            if(!myUid) return;
            const input = document.getElementById('msgInput');
            const text = input.value;
            if(text.trim()) {
                db.ref('chat').push({
                    text: text, sender: isAdmin ? "ç®¡ç†å“¡" : userNickname, role: isAdmin ? "admin" : "member",
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = "";
            }
        }

        function linkify(text) {
            var urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function(url) {
                return '<a class="chat-link" href="' + url + '" target="_blank">' + url + '</a>';
            });
        }

        function renderMessage(msg) {
            const body = document.getElementById('chatBody');
            const div = document.createElement('div');
            div.style.marginBottom = "8px";
            let date = new Date(msg.timestamp);
            let timeStr = date.getHours() + ":" + String(date.getMinutes()).padStart(2, '0');
            let content = linkify(msg.text);
            let color = (msg.role === "admin") ? "#ffeb3b" : "#aaa";
            div.innerHTML = `<span style='color:${color}; font-size:12px;'>[${timeStr} ${msg.sender}]</span> <span style="color:white;">${content}</span>`;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        function loadGPX(input) {
             if (input.files && input.files[0]) {
                if(currentGpxLayer) map.removeLayer(currentGpxLayer);
                var reader = new FileReader(); 
                reader.onload = function(e) {
                    var blob = new Blob([e.target.result], {type: 'application/xml'});
                    var url = URL.createObjectURL(blob);
                    currentGpxLayer = new L.GPX(url, { async: true }).on('loaded', function(e) {
                        map.fitBounds(e.target.getBounds());
                    }).addTo(map);
                };
                reader.readAsText(input.files[0]);
                toggleMenu();
            }
        }

        function editAnnouncement() {
            if(!isAdmin) return;
            let msg = prompt("ä¿®æ”¹å…¬å‘Š:");
            if(msg) {
                db.ref('announcement').set({ text: msg });
                db.ref('chat').push({ text: msg, sender: "ç³»çµ±å…¬å‘Š", type: "announcement", timestamp: firebase.database.ServerValue.TIMESTAMP });
            }
            toggleMenu();
        }
        
        function removeGPX() { if(currentGpxLayer) { map.removeLayer(currentGpxLayer); currentGpxLayer = null; alert("å·²æ¸…é™¤"); } toggleMenu(); }
        function clearChat() { if(confirm("æ¸…ç©º?")) db.ref('chat').remove(); toggleMenu(); }
        function toggleMenu() { document.getElementById('dropdownList').style.display = (document.getElementById('dropdownList').style.display === 'flex') ? 'none' : 'flex'; }
        function toggleChat() { document.getElementById('chatWindow').style.display = (document.getElementById('chatWindow').style.display === 'flex') ? 'none' : 'flex'; }
        function changeNickname() { let name = prompt("æ–°æš±ç¨±:", userNickname); if(name) db.ref('users/'+myUid).update({nickname:name}); toggleMenu(); }
        function exportChatXLS() { toggleMenu(); alert("XLS åŒ¯å‡ºåŠŸèƒ½ (ç¯„ä¾‹)"); }
        function exportWallLogXLS() { toggleMenu(); alert("å…¬å‘ŠåŒ¯å‡ºåŠŸèƒ½ (ç¯„ä¾‹)"); }
        function insertImage() { let url = prompt("ç¶²å€:"); if(url) sendMsg(`<img src="${url}" width="100">`); }

        window.addEventListener('resize', function(){ map.invalidateSize(); });
    </script>
</body>
</html>
