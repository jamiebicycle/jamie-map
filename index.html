<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·ç±³æ¨‚æˆ°è¡“ç³»çµ± v3.1</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background: #222; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* --- é€šç”¨ UI --- */
        .float-btn {
            background: rgba(255, 255, 255, 0.95); border: 1px solid #ccc; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; font-weight: bold; color: #333;
            padding: 8px 12px; font-size: 14px; display: flex; align-items: center; gap: 5px; pointer-events: auto;
        }
        .dropdown-menu {
            display: none; position: absolute; top: 100%; left: 0; background: white;
            border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 180px; overflow: hidden; margin-top: 5px;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 10px; border-bottom: 1px solid #eee; color: #333; cursor: pointer; font-size: 13px; }
        .dropdown-item:active { background: #f0f0f0; }

        /* --- ç‰ˆé¢é…ç½® --- */
        .top-left-panel { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 10px; }
        .top-right-panel { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
        
        /* (ä¿®æ”¹) GPS æŒ‰éˆ•åŠ å¤§ */
        .gps-btn {
            width: 60px; height: 60px; border-radius: 15px; /* æ–¹å½¢åœ“è§’ */
            justify-content: center; font-size: 32px; /* åœ–ç¤ºè®Šå¤§ */
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            border: 2px solid #fff; background: rgba(0, 123, 255, 0.9); color: white;
        }

        /* (ä¿®æ”¹) å·¦å´èŠå¤©å®¤é¢æ¿ */
        .left-chat-panel {
            position: absolute; top: 70px; left: 10px; z-index: 999;
            width: 260px; background: rgba(30, 30, 30, 0.9); 
            border: 1px solid #555; border-radius: 10px; 
            display: flex; flex-direction: column;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.6);
            height: 40vh; /* é«˜åº¦ä½”è¢å¹• 40% */
            transition: height 0.3s;
        }
        .chat-header {
            padding: 8px; background: #007bff; color: white; border-top-left-radius: 10px; border-top-right-radius: 10px;
            font-size: 13px; font-weight: bold; display: flex; justify-content: space-between;
        }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; color: #fff;
            display: flex; flex-direction: column; gap: 5px;
        }
        .chat-msg-row { word-break: break-all; }
        .chat-input-area {
            padding: 5px; border-top: 1px solid #555; display: flex; gap: 5px;
        }
        .chat-input {
            flex: 1; background: #222; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px;
        }
        .chat-send-btn {
            background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;
        }

        /* åº•éƒ¨å€åŸŸ */
        .bottom-panel {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 70%, transparent);
            padding: 10px; display: flex; flex-direction: column; gap: 8px;
        }

        /* æ¬Šé™æ§åˆ¶ */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: block !important; }
        
        /* ç®¡ç†å“¡å°ˆå±¬ï¼šç³»çµ±æ—¥èªŒ (åº•éƒ¨è—è‰²) */
        #systemLogBox {
            background: rgba(33, 76, 116, 0.9); border: 1px solid #4a90e2; border-radius: 5px;
            height: 100px; overflow-y: auto; padding: 5px 10px; font-size: 12px; color: #fff; margin-bottom: 5px;
        }

        /* æˆ°è¡“æŒ‰éˆ• */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        .action-btn { border: none; padding: 15px 0; border-radius: 5px; font-weight: bold; color: white; font-size: 16px; cursor: pointer; }
        .btn-red { background: #d32f2f; box-shadow: 0 0 10px #d32f2f; }
        .btn-yellow { background: #fbc02d; color: #222; box-shadow: 0 0 10px #fbc02d; }
        .btn-green { background: #388e3c; box-shadow: 0 0 10px #388e3c; }
        .btn-blue { background: #1976d2; box-shadow: 0 0 10px #1976d2; }

        /* åå–®ç®¡ç†å½ˆçª— */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 10px; color: #333;
        }
        .member-list-item {
            display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;
        }
        .del-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>
<input type="file" id="gpxUpload" accept=".gpx" style="display: none;">

<div class="top-left-panel">
    <div style="position:relative;">
        <button class="float-btn" onclick="toggleMenu('manageMenu')">âš™ï¸ ç®¡ç†é¸å–®</button>
        <div id="manageMenu" class="dropdown-menu">
            <div class="dropdown-item admin-only" onclick="triggerGpxUpload()">ğŸ“‚ åŒ¯å…¥/æ›´æ› è·¯ç·š</div>
            <div class="dropdown-item admin-only" onclick="clearGpxRoute()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è·¯ç·š</div>
            <div class="dropdown-item admin-only" onclick="openMemberManager()">ğŸ‘¥ æˆå“¡åå–®ç®¡ç†</div>
            <div class="dropdown-item admin-only" onclick="clearChat()">ğŸ’¬ æ¸…é™¤èŠå¤©ç´€éŒ„</div>
            <div class="dropdown-item" onclick="alert('v3.1 Build 20260122')">â„¹ï¸ ç³»çµ±è³‡è¨Š</div>
        </div>
    </div>
</div>

<div class="left-chat-panel">
    <div class="chat-header">
        <span>ğŸ’¬ åœ˜éšŠèŠå¤©å®¤</span>
        <span style="font-size:10px; opacity:0.8;">Live</span>
    </div>
    <div id="chatMessages" class="chat-messages">
        <div style="color:#aaa; text-align:center; margin-top:20px;">è¼‰å…¥ä¸­...</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" class="chat-input" placeholder="è¼¸å…¥è¨Šæ¯...">
        <button class="chat-send-btn" onclick="sendChat()">å‚³é€</button>
    </div>
</div>

<div class="top-right-panel">
    <div style="position:relative;">
        <button id="userBtn" class="float-btn" onclick="toggleMenu('userMenu')">ğŸ‘¤ ç™»å…¥</button>
        <div id="userMenu" class="dropdown-menu right" style="left:auto; right:0;">
            <div class="dropdown-item" onclick="googleLogin()">Google ç™»å…¥</div>
            <div class="dropdown-item" onclick="googleLogout()">ç™»å‡º</div>
        </div>
    </div>
    <button class="float-btn gps-btn" onclick="locateMe()">âŒ–</button>
</div>

<div class="bottom-panel">
    <div id="systemLogBox" class="admin-only">
        <div style="text-align:center;color:#aaa;padding-top:30px;">[ç³»çµ±æ—¥èªŒ] ç›£è½ä¸­...</div>
    </div>

    <div class="action-grid">
        <button class="action-btn btn-red" onclick="updateStatus('å‰å¾€ä¸­')">å‰å¾€ä¸­</button>
        <button class="action-btn btn-yellow" onclick="updateStatus('å·²æŠµé”')">å·²æŠµé”</button>
        <button class="action-btn btn-green" onclick="updateStatus('ç¶­ä¿®ä¸­')">ç¶­ä¿®ä¸­</button>
        <button class="action-btn btn-blue" onclick="updateStatus('å·²å®Œæˆ')">å·²å®Œæˆ</button>
    </div>
</div>

<div id="memberModal" class="modal-overlay">
    <div class="modal-box">
        <h3>ğŸ‘¥ æˆå“¡åå–®ç®¡ç†</h3>
        <div id="memberListContent" style="max-height:300px; overflow-y:auto;">è¼‰å…¥ä¸­...</div>
        <div style="text-align:right; margin-top:15px;">
            <button onclick="document.getElementById('memberModal').style.display='none'" style="padding:8px 15px;">é—œé–‰</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, query, orderBy, limit, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // 1. Firebase Config (è«‹å¡«å…¥)
    const firebaseConfig = {
        apiKey: "AIzaSyB_uFmhh4ENTSHo1oGCW8vEUymDy56c4PE",
        authDomain: "jamielove-map.firebaseapp.com",
        projectId: "jamielove-map",
        storageBucket: "jamielove-map.firebasestorage.app",
        messagingSenderId: "971633917617",
        appId: "1:971633917617:web:95c1b6c57ebc3a530bac90",
    };

    // 2. ç®¡ç†å“¡åå–® (è«‹å¡«å…¥ UID)
    const ADMIN_UIDS = ["oy3ypKCGLYP3vh5saQlWWuFjktB3"]; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // åœ°åœ–åˆå§‹åŒ–
    const map = L.map('map', { zoomControl: false }).setView([24.1512, 120.9324], 13);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map);

    let currentUser = null;
    let userMarker = null;
    let teammates = {};
    let teammateTrails = {};
    let gpxLayer = null;

    // --- æ¬Šé™èˆ‡ç™»å…¥ ---
    window.googleLogin = () => {
        if(!currentUser) signInWithPopup(auth, provider).catch(err => alert(err.message));
    };
    window.googleLogout = () => signOut(auth).then(()=>location.reload());

    onAuthStateChanged(auth, (user) => {
        const btn = document.getElementById('userBtn');
        if (user) {
            currentUser = user;
            btn.innerHTML = `<img src="${user.photoURL}" style="width:20px;border-radius:50%"> ${user.displayName}`;
            if (ADMIN_UIDS.includes(user.uid)) {
                document.body.classList.add('is-admin');
                listenToSystemLogs();
            } else {
                document.body.classList.remove('is-admin');
            }
            startTracking();
            listenToTeammates();
            listenToChat(); // å•Ÿå‹•èŠå¤©å®¤
        } else {
            currentUser = null;
            btn.innerHTML = "ğŸ‘¤ ç™»å…¥";
            document.body.classList.remove('is-admin');
        }
    });

    // --- A. GPX åŒ¯å…¥ä¿®å¾©ç‰ˆ ---
    window.triggerGpxUpload = () => document.getElementById('gpxUpload').click();
    window.clearGpxRoute = () => { if(gpxLayer){ map.removeLayer(gpxLayer); gpxLayer=null; } };

    document.getElementById('gpxUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        window.clearGpxRoute();
        
        // ä½¿ç”¨ URL.createObjectURL è§£æ±ºæœ¬åœ°è·¯å¾‘å•é¡Œ
        const url = URL.createObjectURL(file);
        
        gpxLayer = new L.GPX(url, {
            async: true,
            marker_options: { startIconUrl: null, endIconUrl: null, shadowUrl: null },
            polyline_options: { color: 'red', opacity: 0.8, weight: 6 }
        }).on('loaded', function(e) {
            map.fitBounds(e.target.getBounds());
        }).on('error', function(e) {
