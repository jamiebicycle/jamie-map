<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ·ç±³æ¨‚å–®è»Šé›²ç«¯èª¿åº¦æ¿ v4.3</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        body { overflow: hidden; background-color: #eee; width: 100vw; height: 100dvh; display: flex; flex-direction: column; }

        /* --- ç‰ˆé¢ --- */
        .top-bar {
            flex: 0 0 auto; background: rgba(255,255,255,0.95); 
            padding-top: max(8px, env(safe-area-inset-top)); padding-bottom: 8px; padding-left: 10px; padding-right: 10px;
            display: flex; justify-content: space-between; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2000;
        }
        #map-container { flex: 1; position: relative; width: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 0; }
        .bottom-area {
            flex: 0 0 auto; display: flex; flex-direction: column; gap: 5px; 
            padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); 
            background: #222; z-index: 2000; color: white;
        }

        /* --- UI å…ƒä»¶ --- */
        .top-btn {
            flex: 1; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            text-decoration: none; color: #333; border: 1px solid #ccc; background: white; height: 44px;
        }
        .top-btn:active { background: #f0f0f0; transform: scale(0.98); }
        .btn-login { background-color: #d32f2f; color: white; border-color: #b71c1c; }

        .gps-float-btn {
            position: absolute; top: 15px; right: 15px; width: 50px; height: 50px;
            background-color: white; border: 2px solid #ccc; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 1000; font-size: 24px; color: #333; 
        }

        .ptt-float-btn {
            position: absolute; bottom: 20px; left: 15px; width: 70px; height: 70px;
            background-color: white; border: 3px solid #ccc; border-radius: 50%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 1000;
            color: #333; transition: all 0.1s; user-select: none;
        }
        .ptt-float-btn i { font-size: 24px; margin-bottom: 2px; }
        .ptt-float-btn span { font-size: 10px; font-weight: bold; }
        .ptt-float-btn.talking {
            background-color: #d32f2f; color: white; border-color: #b71c1c;
            transform: scale(1.1); box-shadow: 0 0 15px rgba(211, 47, 47, 0.6);
        }

        .dropdown-menu {
            position: fixed; top: 80px; left: 10px; background: white; border-radius: 8px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none; flex-direction: column; width: 260px;
            overflow: hidden; max-height: 60vh; overflow-y: auto; z-index: 3000;
        }
        .menu-group-title { background-color: #eee; font-size: 13px; color: #666; padding: 8px 12px; font-weight: bold; }
        .dropdown-menu div, .dropdown-menu label { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .admin-only { display: none !important; }

        .chat-window {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; height: 60vh;
            background: rgba(30, 30, 30, 0.98); border-radius: 12px; color: white;
            display: none; flex-direction: column; z-index: 4000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); border: 1px solid #555;
        }
        .chat-header { background: #1976d2; padding: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-radius: 12px 12px 0 0;}
        .chat-body { flex: 1; padding: 10px; overflow-y: auto; font-size: 15px; }
        .chat-input-area { display: flex; padding: 10px; background: #222; border-radius: 0 0 12px 12px; }
        .chat-input-area input { flex: 1; padding: 10px; border-radius: 6px; border: none; font-size: 16px; }
        .chat-input-area button { margin-left: 8px; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; }

        .status-bar { display: flex; gap: 8px; height: 55px; }
        .status-btn { flex: 1; border: none; color: white; font-weight: bold; font-size: 16px; border-radius: 8px; cursor: pointer; opacity: 0.6; }
        .status-btn.active { opacity: 1; transform: scale(1.02); border: 2px solid white; }
        .st-going { background-color: #d32f2f; } .st-arrived { background-color: #fbc02d; color: black; }
        .st-fixing { background-color: #388e3c; } .st-done { background-color: #1976d2; }

        .public-announcement { background: rgba(0, 0, 0, 0.85); color: #ffeb3b; padding: 10px; border-radius: 6px; font-size: 15px; text-align: center; border: 2px solid #fbc02d; margin-bottom: 5px; }
        .admin-private-wall { background: rgba(13, 71, 161, 0.9); color: #fff; padding: 5px; border-radius: 5px; font-size: 12px; display: none; border-left: 4px solid #00e5ff; margin-bottom: 5px; max-height: 60px; overflow-y: auto; }

        .user-avatar-icon { background-color: #2196f3; color: white; border: 2px solid white; border-radius: 50%; text-align: center; line-height: 36px; font-weight: bold; font-size: 18px; width: 36px !important; height: 36px !important; margin: 0 auto; transition: all 0.2s; }
        .status-label { background: white; border: 1px solid #ccc; border-radius: 4px; padding: 2px 5px; font-size: 12px; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.3); font-weight: bold; position: absolute; top: -22px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .talking-marker { animation: pulse-ring 1.5s infinite; border-color: #ffeb3b !important; box-shadow: 0 0 10px #ffeb3b; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(255, 235, 59, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(255, 235, 59, 0); } }

        /* é–å®šç•«é¢èˆ‡å¯†ç¢¼æ¡† */
        #lockScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .lock-btn { margin-top: 15px; padding: 10px 20px; border:none; border-radius:5px; cursor: pointer; font-size: 16px; font-weight: bold; width: 250px; }
        
        /* æ–°å¢ï¼šå¯†ç¢¼è¼¸å…¥å€åŸŸ (éš±è—å¼) */
        #adminLoginArea { display: none; margin-top: 15px; width: 250px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; }
        #adminPwdInput { width: 100%; padding: 10px; border-radius: 5px; border: none; margin-bottom: 10px; font-size: 16px; text-align: center; }

        #gpxInput { display: none; }
    </style>
</head>
<body>

    <div id="lockScreen">
        <i class="fa-solid fa-lock fa-3x" style="margin-bottom: 20px; color: #ff9800;"></i>
        <h2>ç­‰å¾…å¯©æ ¸ä¸­</h2>
        <p>æ‚¨çš„ Google å¸³è™Ÿå·²é€£ç·šã€‚</p>
        <p>è«‹ç­‰å¾…ç®¡ç†å“¡æ‰¹å‡†æ‚¨çš„åŠ å…¥æ¬Šé™ã€‚</p>
        
        <button class="lock-btn" onclick="toggleAdminLoginArea()" style="background: #2196f3; color: white;">
            <i class="fa-solid fa-key"></i> æˆ‘æ˜¯ç®¡ç†å“¡ (ç™»å…¥)
        </button>

        <div id="adminLoginArea">
            <input type="number" id="adminPwdInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            <button class="lock-btn" onclick="submitAdminLogin()" style="background: #4caf50; color: white; margin-top: 0;">
                ç¢ºèª
            </button>
        </div>
        
        <button class="lock-btn" onclick="handleLogout()" style="background: #d32f2f; color: white;">
            <i class="fa-solid fa-right-from-bracket"></i> å–æ¶ˆä¸¦ç™»å‡º
        </button>
    </div>

    <div id="ui-layer">
        <div class="top-bar pointer-auto">
            <button id="menuBtn" class="top-btn btn-menu" onclick="toggleMenu()"><i class="fa-solid fa-gear"></i> é¸å–®</button>
            <div class="top-btn" style="background:#f9f9f9; cursor:default;"><i class="fa-solid fa-signal"></i> <span id="radioStatus">å¾…æ©Ÿ</span></div>
            <button class="top-btn btn-chat" onclick="toggleChat()"><i class="fa-solid fa-comments"></i> èŠå¤©</button>
            <button id="loginBtn" class="top-btn btn-login" onclick="handleGoogleLogin()"><i class="fa-brands fa-google"></i> ç™»å…¥</button>
        </div>

        <div id="map-container">
            <div id="map"></div>
            <button class="gps-float-btn pointer-auto" onclick="locateUser()"><i class="fa-solid fa-crosshairs"></i></button>
            <div id="pttBtn" class="ptt-float-btn pointer-auto"><i class="fa-solid fa-microphone"></i><span>PTT</span></div>
        </div>

        <div class="bottom-area pointer-auto">
            <div id="adminPrivateWall" class="admin-private-wall"></div>
            <div id="publicAnnouncement" class="public-announcement">ğŸ“¢ å…¬å‘Šï¼šè«‹ç™»å…¥ä»¥é–‹å§‹ä½¿ç”¨</div>
            <div class="status-bar">
                <button class="status-btn st-going" onclick="setStatus(this, 'å‰å¾€ä¸­', '#d32f2f')">å‰å¾€ä¸­</button>
                <button class="status-btn st-arrived" onclick="setStatus(this, 'å·²æŠµé”', '#fbc02d')">å·²æŠµé”</button>
                <button class="status-btn st-fixing" onclick="setStatus(this, 'ç¶­ä¿®ä¸­', '#388e3c')">ç¶­ä¿®ä¸­</button>
                <button class="status-btn st-done" onclick="setStatus(this, 'å·²å®Œæˆ', '#1976d2')">å·²å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div id="dropdownList" class="dropdown-menu pointer-auto">
        <div class="menu-group-title admin-only">ç®¡ç†å“¡å°ˆå€</div>
        <div class="admin-only" onclick="reviewMembers()"><i class="fa-solid fa-user-check"></i> å¯©æ ¸æˆå“¡</div>
        <div class="admin-only" onclick="editMemberNickname()"><i class="fa-solid fa-user-pen"></i> ç·¨è¼¯æˆå“¡æš±ç¨±</div>
        <div class="admin-only text-danger" onclick="removeMember()"><i class="fa-solid fa-user-slash"></i> ç§»é™¤æˆå“¡</div>
        <div class="admin-only" onclick="editAnnouncement()"><i class="fa-solid fa-bullhorn"></i> ç™¼å¸ƒå…¬å‘Š</div>
        <div class="admin-only text-danger" onclick="clearChat()"><i class="fa-solid fa-eraser"></i> æ¸…ç©ºèŠå¤©</div>
        
        <div class="menu-group-title">è¨­å®šèˆ‡ç®¡ç†</div>
        <div onclick="changeNickname()"><i class="fa-solid fa-pen"></i> ä¿®æ”¹æˆ‘çš„æš±ç¨±</div>
        <div onclick="toggleAdminLoginAreaInMenu()"><i class="fa-solid fa-lock-open"></i> ğŸ”“ å–å¾—ç®¡ç†æ¬Šé™</div>
        
        <div class="menu-group-title">åœ°åœ–ç®¡ç†</div>
        <label for="gpxInput"><i class="fa-solid fa-folder-open"></i> åŒ¯å…¥ GPX</label>
        <input type="file" id="gpxInput" accept=".gpx" onchange="loadGPX(this)">
        <div class="text-danger" onclick="removeGPX()"><i class="fa-solid fa-trash-can"></i> æ¸…é™¤ GPX</div>
        
        <div class="menu-group-title">èŠå¤©å®¤ç®¡ç†</div>
        <div onclick="exportChatXLS()"><i class="fa-solid fa-file-excel"></i> åŒ¯å‡ºç´€éŒ„</div>
        
        <div style="text-align:center; background:#eee; padding:12px;" onclick="toggleMenu()">â–² é—œé–‰</div>
    </div>

    <div id="chatWindow" class="chat-window pointer-auto">
        <div class="chat-header"><span>åœ˜éšŠèŠå¤©å®¤</span><span style="cursor:pointer;" onclick="toggleChat()">Ã—</span></div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-input-area">
            <button class="btn-img" onclick="insertImage()"><i class="fa-regular fa-image"></i></button>
            <input type="text" id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯..."><button class="btn-send" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <script>
        // --- 1. è¨­å®šå€ ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_uFmhh4ENTSHo1oGCW8vEUymDy56c4PE",
            authDomain: "jamielove-map.firebaseapp.com",
            databaseURL: "https://jamielove-map-default-rtdb.firebaseio.com",
            projectId: "jamielove-map",
            storageBucket: "jamielove-map.firebasestorage.app",
            messagingSenderId: "971633917617",
            appId: "1:971633917617:web:95c1b6c57ebc3a530bac90",
        };
        const agoraAppId = "9e6abdb0be1a4664a94ef071d92c0618"; 
        const channelName = "JamieBikeTeam";

        if (typeof firebase !== 'undefined' && !firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        var db = firebase.database();
        var auth = firebase.auth();
        var provider = new firebase.auth.GoogleAuthProvider();
        auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

        // --- 2. è®Šæ•¸ ---
        var map = L.map('map', { zoomControl: true }).setView([24.1477, 120.6736], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

        let isAdmin = false;
        let myUid = null;
        let userNickname = "è¨ªå®¢";
        let markers = {}; 
        let polylines = {}; 
        let listenersStarted = false; 
        let rtc = { client: null, localAudioTrack: null, joined: false, published: false };

        // --- 3. éŸ³æ•ˆ ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const gain = audioCtx.createGain();
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.3, now);
            const osc = audioCtx.createOscillator();
            osc.connect(gain);

            if (type === 'dingdong') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(659, now);
                osc.start(now); osc.stop(now + 0.5);
            } else if (type === 'msn') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'bikebell') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(2500, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
                osc.start(now); osc.stop(now + 0.8);
            }
        }

        // --- 4. åˆå§‹åŒ– ---
        window.onload = function() {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    myUid = user.uid;
                    userNickname = user.displayName || "éšŠå“¡";
                    document.getElementById('loginBtn').innerHTML = `<i class="fa-solid fa-right-from-bracket"></i> ç™»å‡º`;
                    
                    db.ref('users/' + myUid).once('value').then(snap => {
                        let val = snap.val();
                        if(!val || val.role === 'pending') {
                            if(!val) db.ref('users/'+myUid).set({nickname: userNickname, role: 'pending', lat:0, lng:0});
                            document.getElementById('lockScreen').style.display = 'flex';
                        } else if (val.role === 'banned') {
                            alert("å°é–ä¸­"); auth.signOut();
                        } else {
                            document.getElementById('lockScreen').style.display = 'none';
                            enterMainSystem(val.role);
                        }
                    });
                    
                    db.ref('users/' + myUid + '/role').on('value', s => {
                        if(s.val() === 'active' || s.val() === 'admin') {
                            document.getElementById('lockScreen').style.display = 'none';
                            enterMainSystem(s.val());
                        } else if (s.val() === 'banned') { auth.signOut(); location.reload(); }
                    });

                } else {
                    myUid = null; isAdmin = false; listenersStarted = false;
                    document.getElementById('loginBtn').innerHTML = `<i class="fa-brands fa-google"></i> ç™»å…¥`;
                    document.getElementById('lockScreen').style.display = 'none';
                    updateAdminUI();
                    if(rtc.client) { rtc.client.leave(); rtc.client = null; } 
                }
            });
            document.body.addEventListener('click', function() { if(audioCtx.state === 'suspended') audioCtx.resume(); }, {once:true});
        };

        function enterMainSystem(role) {
            if(role === 'admin') isAdmin = true;
            updateAdminUI();
            if(!listenersStarted) initListeners();
            locateUser();
            if(!rtc.client && agoraAppId.length > 10) initAgora(); 
            playSound('dingdong');
        }

        // --- ç™»å…¥ & å¯†ç¢¼é©—è­‰é‚è¼¯ ---
        function handleGoogleLogin() {
            if (myUid) auth.signOut().then(() => location.reload());
            else auth.signInWithPopup(provider);
        }
        function handleLogout() { auth.signOut().then(() => location.reload()); }

        // é¡¯ç¤º/éš±è—é–å®šç•«é¢çš„å¯†ç¢¼æ¡†
        function toggleAdminLoginArea() {
            const area = document.getElementById('adminLoginArea');
            area.style.display = (area.style.display === 'block') ? 'none' : 'block';
        }

        // é¸å–®ä¸­çš„å¯†ç¢¼é©—è­‰
        function toggleAdminLoginAreaInMenu() {
            let pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            verifyAdminPassword(pwd);
        }

        // æäº¤å¯†ç¢¼é©—è­‰
        function submitAdminLogin() {
            let pwd = document.getElementById('adminPwdInput').value;
            verifyAdminPassword(pwd);
        }

        function verifyAdminPassword(pwd) {
            if (pwd === "Fire_Fire_54889427") {
                db.ref('users/' + myUid).update({ role: 'admin' });
                alert("é©—è­‰æˆåŠŸï¼æ‚¨å·²æˆç‚ºç®¡ç†å“¡ã€‚");
                // æ¬Šé™è®Šæ›´æœƒè‡ªå‹•è§¸ç™¼ listener è§£é–ç•«é¢
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
            }
        }

        function updateAdminUI() {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'flex' : 'none');
            document.getElementById('menuBtn').innerHTML = isAdmin ? `<i class="fa-solid fa-wrench"></i> ç®¡ç†` : `<i class="fa-solid fa-gear"></i> é¸å–®`;
            document.getElementById('adminPrivateWall').style.display = isAdmin ? 'block' : 'none';
        }

        // --- ç›£è½ ---
        function initListeners() {
            listenersStarted = true;
            db.ref('users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                Object.keys(users).forEach(uid => {
                    if (uid === myUid) return;
                    let u = users[uid];
                    if ((u.role === 'active' || u.role === 'admin') && u.lat && u.lng) updateMarker(uid, u);
                });
                Object.keys(markers).forEach(uid => {
                    if (!users[uid] || (users[uid].role !== 'active' && users[uid].role !== 'admin')) {
                        if(markers[uid]) { map.removeLayer(markers[uid]); delete markers[uid]; }
                        if(polylines[uid]) { map.removeLayer(polylines[uid]); delete polylines[uid]; }
                    }
                });
            });

            db.ref('chat').limitToLast(50).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                renderMessage(msg);
                if (Date.now() - msg.timestamp < 5000) {
                    if(msg.type === 'announcement') playSound('dingdong');
                    else playSound('msn');
                }
            });

            db.ref('announcement').on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) document.getElementById('publicAnnouncement').innerText = "ğŸ“¢ " + val.text;
            });
        }

        // --- åœ°åœ– ---
        function updateMarker(uid, u) {
            let latlng = [u.lat, u.lng];
            let statusText = u.status || '...';
            let icon = createAvatarIcon(u.color || "#2196f3", u.nickname, statusText);
            
            if (markers[uid]) {
                markers[uid].setLatLng(latlng);
                markers[uid].setIcon(icon);
                markers[uid].getPopup().setContent(`<b>${u.nickname}</b><br>${statusText}`);
            } else {
                let m = L.marker(latlng, { icon: icon }).addTo(map);
                m.bindPopup(`<b>${u.nickname}</b><br>${statusText}`);
                markers[uid] = m;
            }
            if (!polylines[uid]) polylines[uid] = L.polyline([], {color: u.color||'blue', weight: 3, opacity:0.7}).addTo(map);
            polylines[uid].addLatLng(latlng);
        }

        function createAvatarIcon(color, name, status) {
            let initial = name ? name.charAt(0) : "?";
            let statusHtml = status ? `<div class="status-label" style="color:${color}">${status}</div>` : '';
            return L.divIcon({
                className: 'custom-avatar',
                html: `${statusHtml}<div class="user-avatar-icon" style="background-color:${color}; border-color:white;">${initial}</div>`,
                iconSize: [36, 36], iconAnchor: [18, 18], popupAnchor: [0, -20]
            });
        }

        function locateUser() { map.locate({setView: true, maxZoom: 16}); }
        map.on('locationfound', function(e) {
            if(!myUid) return;
            db.ref('users/' + myUid).update({ lat: e.latlng.lat, lng: e.latlng.lng });
            if (!markers['me']) {
                let icon = createAvatarIcon("#2196f3", userNickname, "æˆ‘");
                markers['me'] = L.marker(e.latlng, {icon:icon}).addTo(map);
            } else { markers['me'].setLatLng(e.latlng); }
        });

        // --- ç®¡ç†åŠŸèƒ½ ---
        function editAnnouncement() {
            let msg = prompt("ç™¼å¸ƒæ–°å…¬å‘Š:");
            if(msg) {
                db.ref('announcement').set({ text: msg });
                db.ref('chat').push({
                    text: msg, sender: "ç³»çµ±å…¬å‘Š", type: "announcement", timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            toggleMenu();
        }

        function reviewMembers() {
            db.ref('users').orderByChild('role').equalTo('pending').once('value', snap => {
                let pendings = snap.val();
                if(!pendings) { alert("ç„¡å¾…å¯©æ ¸æˆå“¡"); return; }
                let list = "";
                Object.keys(pendings).forEach(k => list += `${pendings[k].nickname}\n`);
                let target = prompt(`å¾…å¯©æ ¸åå–®:\n${list}\nè¼¸å…¥æš±ç¨±æ ¸å‡†:`);
                if(target) {
                    let uid = Object.keys(pendings).find(k => pendings[k].nickname === target);
                    if(uid) { db.ref('users/'+uid).update({role:'active'}); alert("å·²æ ¸å‡†"); }
                }
            });
            toggleMenu();
        }

        function editMemberNickname() {
            let target = prompt("è¼¸å…¥è¦ä¿®æ”¹çš„æˆå“¡åŸæš±ç¨±:");
            if(target) {
                db.ref('users').orderByChild('nickname').equalTo(target).once('value', snap => {
                    if(snap.exists()) {
                        let newName = prompt("è¼¸å…¥æ–°æš±ç¨±:");
                        if(newName) {
                            snap.forEach(c => db.ref('users/'+c.key).update({nickname: newName}));
                            alert("ä¿®æ”¹å®Œæˆ");
                        }
                    } else alert("æ‰¾ä¸åˆ°è©²æˆå“¡");
                });
            }
            toggleMenu();
        }

        function removeMember() {
            let target = prompt("è¼¸å…¥è¦ç§»é™¤çš„æš±ç¨±:");
            if(target) {
                db.ref('users').orderByChild('nickname').equalTo(target).once('value', snap => {
                    if(snap.exists()) {
                        if(confirm("ç¢ºå®šç§»é™¤?")) {
                            snap.forEach(c => {
                                db.ref('banned/'+c.key).set(true);
                                db.ref('users/'+c.key).remove();
                            });
                            alert("å·²ç§»é™¤");
                        }
                    } else alert("æ‰¾ä¸åˆ°");
                });
            }
            toggleMenu();
        }

        function clearChat() { if(confirm("æ¸…ç©ºç´€éŒ„?")) db.ref('chat').remove(); toggleMenu(); }

        // --- å…¶ä»– ---
        function setStatus(btn, txt, col) {
            if(!myUid) return;
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            playSound('bikebell'); 
            db.ref('users/' + myUid).update({ status: txt, color: col });
            if(isAdmin) logToAdmin(`${userNickname}: ${txt}`);
        }

        function sendMsg() {
            if(!myUid) return;
            const input = document.getElementById('msgInput');
            const text = input.value;
            if(text.trim()) {
                db.ref('chat').push({
                    text: text, sender: isAdmin?"ç®¡ç†å“¡":userNickname, role: isAdmin?"admin":"member",
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = "";
            }
        }

        function renderMessage(msg) {
            const body = document.getElementById('chatBody');
            const div = document.createElement('div');
            div.style.marginBottom = "8px";
            let date = new Date(msg.timestamp);
            let timeStr = date.getHours() + ":" + String(date.getMinutes()).padStart(2, '0');
            let content = msg.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:cyan;text-decoration:underline;">$1</a>');
            let color = (msg.role === "admin" || msg.type === "announcement") ? "#ffeb3b" : "#aaa";
            div.innerHTML = `<span style='color:${color}; font-size:12px;'>[${timeStr} ${msg.sender}]</span> <span style="color:white;">${content}</span>`;
            body.appendChild(div); body.scrollTop = body.scrollHeight;
        }

        function loadGPX(input) {
             if (input.files && input.files[0]) {
                if(currentGpxLayer) map.removeLayer(currentGpxLayer);
                var r = new FileReader();
                r.onload = function(e) {
                    var blob = new Blob([e.target.result], {type: 'application/xml'});
                    var url = URL.createObjectURL(blob);
                    currentGpxLayer = new L.GPX(url, {async: true, marker_options: {
                        startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png',
                        endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png'
                    }}).on('loaded', function(e) { map.fitBounds(e.target.getBounds()); }).addTo(map);
                };
                r.readAsText(input.files[0]);
                toggleMenu();
            }
        }

        // Agora PTT
        async function initAgora() {
            try {
                rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                rtc.client.on("user-published", async (user, mediaType) => {
                    await rtc.client.subscribe(user, mediaType);
                    if (mediaType === "audio") { user.audioTrack.play(); highlightSpeaker(user.uid, true); }
                });
                rtc.client.on("user-unpublished", (user) => highlightSpeaker(user.uid, false));
                await rtc.client.join(agoraAppId, channelName, null, myUid);
                rtc.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                document.getElementById('pttBtn').style.display = 'flex';
                document.getElementById('radioStatus').innerText = "å·²é€£ç·š";
            } catch (e) { console.error(e); }
        }
        
        const pttBtn = document.getElementById('pttBtn');
        pttBtn.addEventListener('click', async () => {
            if(rtc.published) {
                await rtc.client.unpublish([rtc.localAudioTrack]); rtc.published = false;
                pttBtn.classList.remove('talking'); highlightSpeaker('me', false);
            } else {
                await rtc.client.publish([rtc.localAudioTrack]); rtc.published = true;
                pttBtn.classList.add('talking'); highlightSpeaker('me', true);
            }
        });

        function highlightSpeaker(uid, talking) {
            let m = (uid==='me' || uid===myUid) ? markers['me'] : markers[uid];
            if(m) {
                let el = m.getElement().querySelector('.user-avatar-icon');
                if(el) talking ? el.classList.add('talking-marker') : el.classList.remove('talking-marker');
            }
        }

        function logToAdmin(t) { document.getElementById('adminPrivateWall').innerHTML = `<div>${t}</div>` + document.getElementById('adminPrivateWall').innerHTML; }
        function removeGPX() { if(currentGpxLayer) { map.removeLayer(currentGpxLayer); currentGpxLayer=null; } toggleMenu(); }
        function toggleMenu() { document.getElementById('dropdownList').style.display = document.getElementById('dropdownList').style.display==='flex'?'none':'flex'; }
        function toggleChat() { document.getElementById('chatWindow').style.display = document.getElementById('chatWindow').style.display==='flex'?'none':'flex'; }
        function changeNickname() { let n = prompt("æ–°æš±ç¨±:", userNickname); if(n) db.ref('users/'+myUid).update({nickname:n}); toggleMenu(); }
        function insertImage() { let u = prompt("ç¶²å€:"); if(u) sendMsg(`<img src="${u}" width="100">`); }
        function exportChatXLS() { toggleMenu(); alert("åŠŸèƒ½ä¿ç•™"); }
        function exportWallLogXLS() { toggleMenu(); alert("åŠŸèƒ½ä¿ç•™"); }

        window.addEventListener('resize', ()=>map.invalidateSize());
    </script>
</body>
</html>
