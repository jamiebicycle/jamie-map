<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·ç±³æ¨‚æˆ°è¡“ç³»çµ± v3.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background: #222; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* --- é€šç”¨ UI å…ƒä»¶ --- */
        .float-btn {
            background: rgba(255, 255, 255, 0.95); border: 1px solid #ccc; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; font-weight: bold; color: #333;
            padding: 8px 12px; font-size: 14px; display: flex; align-items: center; gap: 5px; pointer-events: auto;
        }
        .dropdown-menu {
            display: none; position: absolute; top: 100%; left: 0; background: white;
            border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 180px; overflow: hidden; margin-top: 5px;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 10px; border-bottom: 1px solid #eee; color: #333; cursor: pointer; font-size: 13px; }
        .dropdown-item:active { background: #f0f0f0; }

        /* --- ç‰ˆé¢é…ç½® --- */
        /* å·¦ä¸Šæ§åˆ¶å€ */
        .top-left-panel { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 10px; }
        /* å³ä¸Šæ§åˆ¶å€ */
        .top-right-panel { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
        /* å·¦å´é€šè¨Šé¢æ¿ (åƒè€ƒ image_7 çš„èŠå¤©å®¤ä½ç½®) */
        .left-comm-panel {
            position: absolute; top: 70px; left: 10px; z-index: 999;
            background: rgba(30, 30, 30, 0.8); border-radius: 10px; padding: 10px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
        }
        .comm-btn {
            padding: 15px 10px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; font-size: 12px;
        }
        
        /* åº•éƒ¨å€åŸŸ */
        .bottom-panel {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 70%, transparent);
            padding: 10px; display: flex; flex-direction: column; gap: 8px;
        }

        /* --- æ¬Šé™æ§åˆ¶é—œéµ CSS --- */
        /* é è¨­éš±è—ç®¡ç†å“¡å…ƒç´  */
        .admin-only { display: none !important; }
        /* ç•¶ body æœ‰ .is-admin é¡åˆ¥æ™‚ï¼Œé¡¯ç¤ºç®¡ç†å“¡å…ƒç´  */
        body.is-admin .admin-only { display: block !important; }
        
        /* ç®¡ç†å“¡å°ˆå±¬ï¼šè¨Šæ¯ç‰† */
        #messageBox {
            background: rgba(33, 76, 116, 0.85); border: 1px solid #4a90e2; border-radius: 5px;
            height: 100px; overflow-y: auto; padding: 5px 10px; font-size: 12px; color: #fff; margin-bottom: 5px;
        }

        /* æˆ°è¡“æŒ‰éˆ• */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        .action-btn { border: none; padding: 12px 0; border-radius: 5px; font-weight: bold; color: white; font-size: 14px; }
        .btn-red { background: #d32f2f; box-shadow: 0 0 10px #d32f2f; }
        .btn-yellow { background: #fbc02d; color: #222; box-shadow: 0 0 10px #fbc02d; }
        .btn-green { background: #388e3c; box-shadow: 0 0 10px #388e3c; }
        .btn-blue { background: #1976d2; box-shadow: 0 0 10px #1976d2; }
    </style>
</head>
<body>

<div id="map"></div>

<input type="file" id="gpxUpload" accept=".gpx" style="display: none;">

<div class="top-left-panel">
    <div style="position:relative;">
        <button class="float-btn" onclick="toggleMenu('manageMenu')">âš™ï¸ ç®¡ç†</button>
        <div id="manageMenu" class="dropdown-menu">
            <div class="dropdown-item admin-only" onclick="triggerGpxUpload()">ğŸ“‚ åŒ¯å…¥ GPX è·¯ç·š</div>
            <div class="dropdown-item admin-only" onclick="clearGpxRoute()">ğŸ—‘ï¸ æ¸…é™¤è·¯ç·š</div>
            <div class="dropdown-item admin-only" onclick="exportCSV()">ğŸ“Š åŒ¯å‡ºè¨Šæ¯ç´€éŒ„</div>
            <div class="dropdown-item admin-only" style="color:#999;cursor:not-allowed">ğŸ‘¥ åå–®ç®¡ç† (æœªé–‹æ”¾)</div>
            <div class="dropdown-item" onclick="alert('æ·ç±³æ¨‚æˆ°è¡“ç³»çµ± v3.0')">â„¹ï¸ é—œæ–¼ç³»çµ±</div>
        </div>
    </div>
</div>

<div class="left-comm-panel">
    <div style="color:#ccc; font-size:12px; text-align:center;">é€šè¨Šé¢æ¿</div>
    <a href="zello://" class="comm-btn" style="background:#F57C00;text-decoration:none;">
        <span style="font-size:20px">ğŸ“±</span> Zello
    </a>
    <button class="comm-btn" style="background:#00796B;" onclick="alert('è«‹æ‰‹å‹•åˆ‡æ›è‡³ Meshtastic App')">
        <span style="font-size:20px">ğŸ“¡</span> Mesh
    </button>
</div>

<div class="top-right-panel">
    <button id="userBtn" class="float-btn" onclick="googleLogin()">ğŸ‘¤ ç™»å…¥</button>
    <button class="float-btn" style="padding:10px;" onclick="locateMe()">âŒ–</button>
</div>

<div class="bottom-panel">
    <div id="messageBox" class="admin-only">
        <div style="text-align:center;color:#aaa;padding-top:30px;">ç­‰å¾…é€£ç·šæˆ–ç„¡æ¬Šé™...</div>
    </div>

    <div class="action-grid">
        <button class="action-btn btn-red" onclick="updateStatus('å‰å¾€ä¸­')">å‰å¾€ä¸­</button>
        <button class="action-btn btn-yellow" onclick="updateStatus('å·²æŠµé”')">å·²æŠµé”</button>
        <button class="action-btn btn-green" onclick="updateStatus('ç¶­ä¿®ä¸­')">ç¶­ä¿®ä¸­</button>
        <button class="action-btn btn-blue" onclick="updateStatus('å·²å®Œæˆ')">å·²å®Œæˆ</button>
    </div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ==========================================
    // 1. è¨­å®šå€
    // ==========================================
    // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyB_uFmhh4ENTSHo1oGCW8vEUymDy56c4PE",
        authDomain: "jamielove-map.firebaseapp.com",
        projectId: "jamielove-map",
        storageBucket: "jamielove-map.firebasestorage.app",
        messagingSenderId: "971633917617",
        appId: "1:971633917617:web:95c1b6c57ebc3a530bac90",
    };

    // âš ï¸âš ï¸âš ï¸ é—œéµï¼šè¨­å®šç®¡ç†å“¡ UID åˆ—è¡¨ âš ï¸âš ï¸âš ï¸
    // è«‹å°‡æ‚¨çš„ Google UID å¡«å…¥æ­¤é™£åˆ—ï¼Œåªæœ‰é€™äº›äººæœƒçœ‹åˆ°ç®¡ç†ä»‹é¢
    // ä¾‹å¦‚: const ADMIN_UIDS = ["AbCdEfGhIjKlMnOpQrStUvWxYz12"];
    const ADMIN_UIDS = ["oy3ypKCGLYP3vh5saQlWWuFjktB3"]; 


    // Firebase åˆå§‹åŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // åœ°åœ–åˆå§‹åŒ–
    const map = L.map('map', { zoomControl: false }).setView([24.1512, 120.9324], 13);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map);

    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let userMarker = null;
    let teammates = {}; 
    let teammateTrails = {}; // å­˜æ”¾éšŠå‹è»Œè·¡ç·š
    let gpxLayer = null;     // å­˜æ”¾ GPX è·¯ç·šå±¤

    // ==========================================
    // 2. æ ¸å¿ƒé‚è¼¯ï¼šæ¬Šé™èˆ‡ç™»å…¥
    // ==========================================
    window.googleLogin = () => {
        if(currentUser) {
             if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) signOut(auth).then(()=>location.reload());
        } else {
            signInWithPopup(auth, provider).catch(err => alert(err.message));
        }
    };

    onAuthStateChanged(auth, (user) => {
        const btn = document.getElementById('userBtn');
        if (user) {
            currentUser = user;
            btn.innerHTML = `<img src="${user.photoURL}" style="width:20px;border-radius:50%"> ${user.displayName}`;
            
            // ğŸ”¥ é—œéµæ¬Šé™åˆ¤æ–· ğŸ”¥
            if (ADMIN_UIDS.includes(user.uid)) {
                // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œåœ¨ body åŠ ä¸Šè­˜åˆ¥é¡åˆ¥ï¼ŒCSS æœƒè‡ªå‹•é¡¯ç¤ºéš±è—å…ƒç´ 
                document.body.classList.add('is-admin');
                console.log("ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨");
                listenToLogs(); // åªæœ‰ç®¡ç†å“¡éœ€è¦ç›£è½æ—¥èªŒ
            } else {
                document.body.classList.remove('is-admin');
            }

            startTracking();
            listenToTeammates();
        } else {
            currentUser = null;
            btn.innerHTML = "ğŸ‘¤ ç™»å…¥";
            document.body.classList.remove('is-admin');
        }
    });

    // ==========================================
    // 3. åŠŸèƒ½å¯¦ä½œ
    // ==========================================

    // --- A. GPX è·¯ç·šåŠŸèƒ½ (ç®¡ç†å“¡ç”¨) ---
    window.triggerGpxUpload = () => document.getElementById('gpxUpload').click();
    window.clearGpxRoute = () => {
        if(gpxLayer) { map.removeLayer(gpxLayer); gpxLayer = null; }
    };
    
    document.getElementById('gpxUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        // æ¸…é™¤èˆŠè·¯ç·š
        clearGpxRoute();
        // ä½¿ç”¨ Leaflet-GPX è§£æä¸¦ç¹ªè£½
        gpxLayer = new L.GPX(file, {
            async: true,
            marker_options: { startIconUrl: null, endIconUrl: null, shadowUrl: null },
            polyline_options: { color: 'red', opacity: 0.8, weight: 5 } // ç´…è‰²ç²—ç·š
        }).on('loaded', function(e) {
            map.fitBounds(e.target.getBounds()); // è‡ªå‹•ç¸®æ”¾åˆ°è·¯ç·šç¯„åœ
        }).addTo(map);
        toggleMenu('manageMenu'); // é—œé–‰é¸å–®
    });


    // --- B. GPS å®šä½èˆ‡è»Œè·¡ ---
    function startTracking() {
        if (!navigator.geolocation) return;
        navigator.geolocation.watchPosition((pos) => {
            const { latitude, longitude } = pos.coords;
            const now = new Date().getTime();
            
            // æ›´æ–°è‡ªå·±çš„ä½ç½®èˆ‡åœ°åœ–ä¸­å¿ƒ
            if (!userMarker) {
                userMarker = L.marker([latitude, longitude], {icon: getIcon('blue'), zIndexOffset: 1000}).addTo(map);
                map.setView([latitude, longitude], 16);
            } else {
                userMarker.setLatLng([latitude, longitude]);
            }

            // å¯«å…¥è³‡æ–™åº« (åŒ…å«è»Œè·¡ç´€éŒ„)
            // æ³¨æ„ï¼šé€™è£¡ç°¡åŒ–è™•ç†ï¼Œæ¯æ¬¡éƒ½å¯«å…¥æ–°çš„åº§æ¨™é»åˆ°ä¸€å€‹å­é›†åˆï¼Œä»¥å»ºç«‹è»Œè·¡
            addDoc(collection(db, `teams/${currentUser.uid}/history`), {
                lat: latitude, lng: longitude, timestamp: now
            });

            // åŒæ™‚æ›´æ–°ä¸»è¦ç‹€æ…‹
            setDoc(doc(db, "teams", currentUser.uid), {
                name: currentUser.displayName, lat: latitude, lng: longitude,lastUpdate: now
            }, { merge: true });

        }, err => console.error(err), { enableHighAccuracy: true });
    }

    // --- C. ç›£è½éšŠå‹èˆ‡ç¹ªè£½è»Œè·¡ ---
    function listenToTeammates() {
        onSnapshot(collection(db, "teams"), (snap) => {
            snap.forEach(docSnapshot => {
                if(docSnapshot.id === currentUser.uid) return;
                updateTeammate(docSnapshot.id, docSnapshot.data());
                // ç›£è½è©²éšŠå‹çš„è»Œè·¡æ­·å²
                listenToTrail(docSnapshot.id);
            });
        });
    }

    function updateTeammate(uid, data) {
        const popupHtml = `<b>${data.name}</b><br><span style="color:red">${data.status||'å¾…å‘½'}</span><br>${data.statusTime||''}`;
        if(teammates[uid]) {
            teammates[uid].setLatLng([data.lat, data.lng]).setPopupContent(popupHtml);
        } else {
            teammates[uid] = L.marker([data.lat, data.lng], {icon: getIcon('green')}).addTo(map).bindPopup(popupHtml);
        }
    }

    // ç¹ªè£½éšŠå‹è»Œè·¡ (è®€å–æœ€è¿‘ 30 å€‹é»)
    function listenToTrail(uid) {
        const q = query(collection(db, `teams/${uid}/history`), orderBy("timestamp", "desc"), limit(30));
        onSnapshot(q, (snap) => {
            const trailPoints = [];
            snap.forEach(doc => {
                const d = doc.data();
                trailPoints.unshift([d.lat, d.lng]); // åŠ åˆ°é™£åˆ—é–‹é ­ï¼Œç¢ºä¿é †åºæ­£ç¢º
            });
            
            if (teammateTrails[uid]) map.removeLayer(teammateTrails[uid]);
            // ç¹ªè£½ç¶ è‰²è™›ç·šè»Œè·¡
            if (trailPoints.length > 1) {
                teammateTrails[uid] = L.polyline(trailPoints, {color: 'green', dashArray: '5, 10', weight: 3, opacity: 0.6}).addTo(map);
            }
        });
    }

    // --- D. ç‹€æ…‹æ›´æ–° (ç™¼é€è¨Šæ¯) ---
    window.updateStatus = async (status) => {
        if (!currentUser || !userMarker) return alert("è«‹å…ˆç™»å…¥ä¸¦ç­‰å¾…å®šä½");
        const pos = userMarker.getLatLng();
        const nowStr = new Date().toLocaleTimeString();
        
        // æ›´æ–°å€‹äººç‹€æ…‹
        await setDoc(doc(db, "teams", currentUser.uid), { status: status, statusTime: nowStr }, { merge: true });
        // å¯«å…¥å…¨åŸŸæ—¥èªŒ (çµ¦ç®¡ç†å“¡çœ‹)
        await addDoc(collection(db, "logs"), {
            uid: currentUser.uid, name: currentUser.displayName, msg: status,
            coord: `${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}`, timestamp: new Date().getTime()
        });
    };

    // --- E. ç®¡ç†å“¡åŠŸèƒ½ï¼šç›£è½æ—¥èªŒèˆ‡åŒ¯å‡º ---
    function listenToLogs() {
        const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50));
        onSnapshot(q, (snapshot) => {
            const box = document.getElementById('messageBox');
            box.innerHTML = "";
            snapshot.forEach((doc) => {
                const d = doc.data();
                const time = new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                box.innerHTML += `<div style="border-bottom:1px solid #555;padding:2px 0;"><span style="color:gold">[${time}]</span> <span style="color:#87ceeb">${d.name}</span>: ${d.msg} <span style="font-size:10px;color:#ccc">(${d.coord})</span></div>`;
            });
        });
    }

    window.exportCSV = async () => {
        const querySnapshot = await getDocs(collection(db, "logs"));
        let csv = "æ™‚é–“,äººå“¡,ç‹€æ…‹,åº§æ¨™\n";
        querySnapshot.forEach((d) => {
            const data = d.data();
            csv += `${new Date(data.timestamp).toLocaleString()},${data.name},${data.msg},"${data.coord}"\n`;
        });
        downloadFile(csv, `æˆ°è¡“ç´€éŒ„.csv`);
    };

    // ==========================================
    // 4. è¼”åŠ©å‡½å¼
    // ==========================================
    window.toggleMenu = (id) => document.getElementById(id).classList.toggle('show');
    map.on('click', () => document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.remove('show')));
    window.locateMe = () => userMarker ? map.setView(userMarker.getLatLng(), 16) : alert("å®šä½ä¸­...");
    
    function getIcon(color) {
        return L.divIcon({
            className: 'custom-icon',
            html: `<div style="background:${color};width:14px;height:14px;border:2px solid #fff;border-radius:50%;box-shadow:0 0 4px #000;"></div>`,
            iconSize: [18, 18]
        });
    }
    function downloadFile(content, fileName) {
        const blob = new Blob(["\uFEFF"+content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
    }
</script>
</body>
</html>
